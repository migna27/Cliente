<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cyber Snake</title>
    <style>
        body {
            margin: 0; background-color: #050505; overflow: hidden;
            font-family: 'Segoe UI', monospace; color: #00FF00;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100vh; user-select: none;
        }
        canvas {
            border: 2px solid #00FF00; 
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            background: #000; cursor: none;
            outline: none;
        }
        #ui-layer {
            position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none;
        }
        h1 { margin: 0; font-size: 3em; text-shadow: 0 0 10px #00FF00; letter-spacing: 5px; }
        #game-over-screen {
            display: none; position: absolute; background: rgba(0, 20, 0, 0.95);
            padding: 40px; border: 2px solid #00FF00; box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
            text-align: center; z-index: 20; border-radius: 8px;
        }
        button {
            background: transparent; color: #00FF00; border: 2px solid #00FF00;
            padding: 10px 30px; font-size: 1.5em; cursor: pointer; font-weight: bold;
            margin-top: 20px; text-transform: uppercase; transition: 0.2s;
        }
        button:hover { background: #00FF00; color: #000; box-shadow: 0 0 20px #00FF00; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1>CYBER SNAKE</h1>
        <p style="font-size: 1.5em;">SCORE: <span id="score">0</span></p>
    </div>

    <canvas id="gameCanvas" width="600" height="600" tabindex="1"></canvas>

    <div id="game-over-screen">
        <h2 style="color: #FF0000; font-size: 3em; margin: 0; text-shadow: 0 0 10px red;">CRASHED</h2>
        <p>FINAL SCORE: <span id="final-score" style="color: #fff; font-size: 2em;">0</span></p>
        <p id="upload-msg" style="color: #888; font-style: italic;">UPLOADING TO SERVER...</p>
        <button onclick="resetGame()">RETRY</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Auto-focus para capturar teclado sin hacer click
    window.onload = () => canvas.focus();

    // Configuraci칩n
    const gridSize = 20;
    const tileCount = canvas.width / gridSize;
    let score = 0;
    
    // Variables de Juego
    let snake = [{x: 10, y: 10}];
    let velocity = {x: 1, y: 0}; // Empieza movi칠ndose a la derecha
    let food = {x: 15, y: 15};
    let gameRunning = true;
    let speed = 100;

    // Red (Env칤o de Puntajes)
    async function enviarPuntaje(puntos) {
        const msg = document.getElementById('upload-msg');
        try {
            await fetch('/send', { 
                method: 'POST', 
                body: JSON.stringify({ message: `/submit_score snake ${puntos}` }) 
            });
            await fetch('/send', { 
                method: 'POST', 
                body: JSON.stringify({ message: `游냀 [ARCADE] He logrado ${puntos} puntos en Cyber Snake!` }) 
            });
            msg.innerText = "UPLOAD COMPLETE"; msg.style.color = "#00FF00";
        } catch { 
            msg.innerText = "OFFLINE MODE"; msg.style.color = "#FF0000"; 
        }
    }

    function gameUpdate() {
        if (!gameRunning) return;

        // Mover cabeza
        const head = {x: snake[0].x + velocity.x, y: snake[0].y + velocity.y};

        // 1. Colisi칩n Paredes
        if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
            gameOver();
            return;
        }

        // 2. Colisi칩n Cuerpo
        for (let i = 0; i < snake.length; i++) {
            if (snake[i].x === head.x && snake[i].y === head.y) {
                gameOver();
                return;
            }
        }

        snake.unshift(head); // Agregar nueva cabeza

        // 3. Comer Manzana
        if (head.x === food.x && head.y === food.y) {
            score += 10;
            document.getElementById('score').innerText = score;
            
            // Generar nueva comida inmediatamente
            placeFood();
            
            // Aumentar dificultad (Velocidad)
            if(speed > 50) speed -= 1; 
        } else {
            // Si no come, eliminar la cola para mantener tama침o
            snake.pop();
        }

        draw();
        setTimeout(gameUpdate, speed);
    }

    function draw() {
        // Fondo Negro
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Grid Cyberpunk (Suave)
        ctx.strokeStyle = '#111';
        for(let i=0; i<tileCount; i++) {
            ctx.beginPath(); ctx.moveTo(i*gridSize,0); ctx.lineTo(i*gridSize,canvas.height); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,i*gridSize); ctx.lineTo(canvas.width,i*gridSize); ctx.stroke();
        }

        // Dibujar Comida (Brillante)
        ctx.fillStyle = '#FF0055';
        ctx.shadowBlur = 20; ctx.shadowColor = "#FF0055";
        ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize-2, gridSize-2);
        ctx.shadowBlur = 0;

        // Dibujar Serpiente
        ctx.fillStyle = '#00FF00';
        for (let i=0; i<snake.length; i++) {
            let part = snake[i];
            // La cabeza brilla m치s
            if (i === 0) { ctx.shadowBlur = 15; ctx.shadowColor = "#00FF00"; }
            else { ctx.shadowBlur = 0; }
            
            ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize-2, gridSize-2);
        }
        ctx.shadowBlur = 0;
    }

    function placeFood() {
        // Posici칩n aleatoria
        food.x = Math.floor(Math.random() * tileCount);
        food.y = Math.floor(Math.random() * tileCount);
        
        // Asegurar que no aparezca ENCIMA de la serpiente
        for (let part of snake) {
            if (part.x === food.x && part.y === food.y) {
                placeFood(); // Intentar de nuevo recursivamente
                return;
            }
        }
    }

    function gameOver() {
        gameRunning = false;
        document.getElementById('game-over-screen').style.display = 'block';
        document.getElementById('final-score').innerText = score;
        enviarPuntaje(score);
    }

    function resetGame() {
        snake = [{x: 10, y: 10}];
        velocity = {x: 1, y: 0}; // Reset velocidad
        score = 0;
        speed = 100;
        document.getElementById('score').innerText = '0';
        document.getElementById('game-over-screen').style.display = 'none';
        gameRunning = true;
        placeFood();
        gameUpdate();
        canvas.focus();
    }

    // --- CONTROLES MEJORADOS (Flechas + WASD) ---
    window.addEventListener('keydown', e => {
        
        // Evitar scroll con flechas
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight", "Space"].indexOf(e.code) > -1) {
            e.preventDefault();
        }

        const key = e.key.toLowerCase(); // Normalizar a min칰sculas para detectar 'W' y 'w'

        // Arriba (W o Flecha Arriba)
        if ((key === 'arrowup' || key === 'w') && velocity.y === 0) {
            velocity = {x: 0, y: -1};
        }
        // Abajo (S o Flecha Abajo)
        else if ((key === 'arrowdown' || key === 's') && velocity.y === 0) {
            velocity = {x: 0, y: 1};
        }
        // Izquierda (A o Flecha Izquierda)
        else if ((key === 'arrowleft' || key === 'a') && velocity.x === 0) {
            velocity = {x: -1, y: 0};
        }
        // Derecha (D o Flecha Derecha)
        else if ((key === 'arrowright' || key === 'd') && velocity.x === 0) {
            velocity = {x: 1, y: 0};
        }
        
        // Reiniciar con Espacio si est치 en Game Over
        if (e.code === 'Space' && !gameRunning) {
            resetGame();
        }
    });

    // Iniciar
    placeFood();
    gameUpdate();

</script>
</body>
</html>